# vim: set ft=yaml ts=2 expandtab:
#
# Copyright (c) Markus Falb <markus.falb@mafalb.at>
# GNU General Public License v3.0+
# see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt
---

name: Molecule

on:  # yamllint disable-line rule:truthy

  # make it reusable
  workflow_call:
    inputs:
      targeted_branch:
        type: string
        required: true
      scenario:
        type: string
        default: default
      target:
        type: string
      filename:
        type: string


jobs:

  molecule:

    runs-on: ubuntu-22.04

    env:
      CI_IMAGE: ${{ matrix.image }}
      CI_HOSTNAME: ci-${{ matrix.os }}
      CI_DRIVER: podman
      PY_COLORS: 1
      ANSIBLE_FORCE_COLOR: 1
      TARGETED_BRANCH: ${{ inputs.targeted_branch }}

    steps:

      - name: Checkout workflows
        uses: actions/checkout@v4
        with:
          repository: mafalb/workflows
          path: workflows
          ref: f-ansiblecollection

      - name: Install Ansible
        uses: ./workflows/.github/actions/installansible
        with:
          extra_packages: 'molecule_podman,molecule'
          ref: dev

      - name: Download the collection artifact
        if: inputs.filename
        uses: actions/download-artifact@v4
        with:
          name: ansible-collections-${{ inputs.targeted_branch }}

      # Download the needed collections
      # We use ansible-galaxy, not actions/checkout
      #
      - name: Install the collection we want to test
        working-directory: ${{ github.workspace }}
        env:
          FILENAME: ${{ inputs.filename }}
          SERVER_URL: ${{ github.server_url }}
          CI_REPO: ${{ github.repository }}
          CI_REF: ${{ github.sha }}
        run: |
          # install the collection we want to test
          if test -n "$FILENAME"; then
              ansible-galaxy collection install "$FILENAME" -p collections
          else
              ansible-galaxy collection install git+"$SERVER_URL"/"$CI_REPO".git,"$CI_REF" -p collections
          fi

      - name: Get Info
        id: info
        env:
          CI_REPO: ${{ github.repository }}
          CI_REF: ${{ github.sha }}
          SERVER: raw.githubusercontent.com
        uses: ./workflows/.github/actions/ansiblecollectioninfo
        with:
          targeted_branch: ${{ github.sha }}
          filename: ${{ inputs.filename }}

      - name: Set working directory
        env:
          namespace: ${{ steps.info.outputs.namespace }}
          collection_name: ${{ steps.info.outputs.collection_name }}
        run: |
          test -n "$namespace"
          test -n "$collection_name"
          # we use info from galaxy.yml in above Get Info step
          # be paranoid
          cd collections/ansible_collections/$namespace/$collection_name
          pwd
          tree
          grep ^galaxy.yml .github/CODEOWNERS
          echo "working-directory=collections/ansible_collections/$namespace/$collection_name" >>GITHUB_ENV

      - name: run molecule tests
        working-directory: ${{ env.working-directory }}
        env:
          ENV_FILE: $GITHUB_WORKBENCH/workflows/env/${{ inputs.target }}.yml
          SCENARIO: ${{ inputs.scenario }}
        run: |
          source ~/.virtualenvs/ansible/bin/activate
          molecule -e "$ENV_FILE" -c molecule/resources/molecule.yml test -s "$SCENARIO"

...

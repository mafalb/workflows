# vim: set ft=yaml ts=2 expandtab:
#
# Copyright (c) Markus Falb <markus.falb@mafalb.at>
# GNU General Public License v3.0+
# see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt
---

name: Sanity

on:  # yamllint disable-line rule:truthy

  # make it reusable
  workflow_call:
    inputs:
      targeted_branch:
        type: string

jobs:

  reusables:

    runs-on: ubuntu-latest
    env:
      BASE_BRANCH: ${{ github.base_ref }}
      HEAD_BRANCH: ${{ github.ref_name }}

    steps:

      - name: Debug
        run: |
          echo "$BASE_BRANCH"
          echo "$HEAD_BRANCH"

      - name: Checkout ourself
        uses: actions/checkout@v4

      - name: Check default branch is called 'main'
        run: |
          default=$(git ls-remote --symref ${{ github.server_url }}/${{ github.repository }} HEAD | awk -F'[/\t]' 'NR == 1 {print $3}')
          echo default branch is "$default"
          test "$default" = "main"

      - name: Check for @dev references to reusable workflows
        # pull_request against main or branch is main
        if: |
          github.base_ref == 'main' || github.ref_name == 'main' ||
          github.base_ref == 'master' || github.ref_name == 'master'
        run: |
          ! grep -v grep .github/workflows/*.yml | grep -E "workflows/.*yml@[^m][^a]?[^i]?[^n]?"

      - name: Check that CODEOWNERS file is present
        run: test -f .github/CODEOWNERS
...
